# 3. 케이블의 앞은 LAN기기

1. 케이블과 리피터, 허브 속을 신호가 흘러감

   컴퓨터에서 나온 신호는 케이블을 통해 리피터 허브 등을 경유하여 진행함. 신호가 흐르는 도중에 약해지거나 변형되는것을 억제하기 위함

2. 스위칭 허브의 패킷 중계 동작

   스위칭 허브는 신호를 흘리지 않고 패킷의 신호를 수신하여 디지털 데이터의 형태로 되돌려주고, 다시 신호로 고쳐서 송신하는 동작을 통해 패킷을 운반

3. 라우터의 패킷 중계 동작

   스위칭 허브와 마찬가지로 패킷을 중계하지만 스위칭 허브는 이더넷 구조 기반, 라우터는 IP 구조 기반

4. 라우터의 부가 기능

   인터넷의 출입구에 배치하는 라우터는 일반적으로 private 주소를 글로벌 주소로 변환하는 주소 변환 기능과 위험한 패킷을 차단하는 패킷 필터링 기능을 이용함



## 케이블과 리피터, 허브 속을 신호가 흘러감

### 하나하나의 패킷이 독립된 것으로 동작

- 컴퓨터에서 송신된 패킷은 허브나 라우터라는 중계 장치에 의해 중계되어 목적지를 향해 진행함
- 중계동작은 데이터 부분을 보지 않고 패킷을 중계
- 클라이언트가 리피터허브-스위칭허브-라우터를 경유하여 인터넷에 나가는 것으로 간주하고 설명

### LAN 케이블은 신호를 약화시키지 않는 것이 핵심

- NIC의 PHY(MAU) 회로에서 전기 신호로 형태를 바꾼 패킷은 RJ-45 커넥터를 통해 트위스트 페어 케이블에 들어감
- 이더넷의 신호의 실체는 플러스와 마이너스의 전압이므로 신호가 2개 1조로 꼬여있음
- 송출한 신호는 그대로의 모습으로 허브에 도착하는 것이 아니라 허브에 도착할 때는 신호가 약해짐. -> 케이블을 통과하는 사이에 신호의 에너지가 조금씩 떨어지므로 케이블의 길이가 길어질수록 신호가 약해짐
- 이더넷은 사각형의 각진 신호를 사용하지만 전송하는 과정에서 각이 뭉개져서 둥글게 됨
- 신호의 각진 부분은 전압이 급격히 변화하는데, 이는 해당 부분의 주파수가 높다는 것 -> 높은 신호는 약해지므로 급격한 변화가 없어져서 각이 뭉개짐
- 잡음이 없고 조건이 좋은 경우에도 신호가 도착할 때는 이와 같이 변형되는데, 이것에 잡음의 영향까지 더해지면 매우 심각하게 변형됨 -> 통신 오류의 원인이 됨

### '꼼'은 잡음을 방지하기 위한 방법

- LAN 케이블로 사용하는 트위스트 페어 케이블에는 잡음의 영향을 억제하는 대책이 마련되어 있는데 이것이 '꼼'
- 잡음의 원인 - 케이블의 주위에서 발생하는 전자파
- 전자파가 금속 등의 도전체에 닿으면 그 안에 전류가 그 안에 전류가 발생한다는 성질이 있음
- 이 때문에 케이블의 주위에 전자파가 있으면 신호와는 다른 전류가 케이블 안에 흐름
- 신호도 전류이므로 잡음에 의해 생기는 전류와 다르지 않음. 따라서 신호와 잡음의 전류가 뒤섞여서 신호의 파형이 변형됨
- 케이블이 영향을 받는 전자파는 두 종류로 나뉨
  - 모니터, 형광등, CRT모니터와 같은 기기에서 누설되는 전자파 -> 케이블의 밖에서 오는 것으로, 선을 꼼으로써 막을 수 있음
  - 같은 케이블 안의 인접한 신호선에서 누설되는 전자파 -> 신호선 안에는 신호라는 전류가 흐르므로 전류에 의해 주위에 전자파가 생김. 이것이 다른 신호선에 대한 잡음이 되는데, 이러한 잡음에 의한 영향을 crosstalk라고 함
- 잡음은 원래 강한 것이 아니지만 거리가 가까운 곳이 문제임
- 전자파는 발생 근원에서 떨어지면 확산되어 약해지는데, 한 개의 케이블 안에 있는 신호선은 거리가 가까우므로 전자파가 약해지기 전에 인접 신호선에 도달해 버림. -> 신호선에서 나오는 약간의 전자파가 주위의 신호선에 닿아 여기에서 전류를 발생시키는 것
- 따라서 신호선을 마주 꼬면 잡음의 영향이 줄어들면서 케이블의 성능이 향상됨
- 이외에도 신호선 사이의 거리를 유지하기 위해 신호선 사이에 구분판을 넣거나 전자파를 차단하기 위해  금속성의 실드라는 피복을 입히는 등 여러 가지 대책이 마련되어 있음

### 리피터 허브는 연결되어 있는 전체 케이블에 신호를 송신함

- 신호가 리피터 허브에 도달하면 LAN 전체에 신호가 흩어짐
- 리피터 허브의 내부 구조
  - NIC 내부에 있는 PHY(MAU) 회로와 역할이 같은 회로가 있음
  - 이것을 NIC측과 같이 RJ-45 커넥터에 직접 접속하면 신호를 제대로 수신할 수 없음
  - 제대로 수신하려면 송신 단자에서 보낸 신호를 수신 단자로 받도록 해야 함
  - 허브 안의 PHY(MAU) 회로와 커넥터 사이의 신호선을 교차시켜서 접속하는 것은 이 때문
  - 리피터 허브에서 끝의 커넥터에는 MDI/MDI-X와 같이 쓰여있는 전환 스위치가 붙어있음
  - MDI - RJ-45 커넥터와 신호 송수신 회로를 직접 결선한 것
  - MDI-X - 교차하여 결선한 것
  - 허브의 커넥터 부분은 보통 MDI-X이므로 허브끼리 접속할 때는 한쪽을 MDI로 설정해야 함
  - MDI로 전환하는 스위치가 없고 모든 커넥터가 MDI-X인 경우에는 크로스 케이블로 허브들을 접속함
- 리피터 허브에서 PHY(MAU) 회로의 수신부에 도달한 신호는 여기부터 리피터 회로에 들어감
- 리피터 회로는 들어오는 신호를 그대로 커넥터 부분에 송출
- 신호는 모든 커넥터에서 나가면서 리피터 허브에 접속한 전체 기기에 도달함
- 신호를 수신한 기기는 맨 앞에 있는 MAC 헤더에 쓰여있는 수신처 MAC 주소를 조사하여 자신인지 아닌지 판단



## 스위칭 허브의 패킷 중계 동작

### 스위칭 허브는 주소 테이블로 중계

스위칭 허브는 이더넷의 패킷을 그대로 목적지를 향해 중계하도록 만들어짐

1. 신호가 커넥터 부분에 도달하여 PHY(MAU) 회로에서 수신되는 부분까지는 리피터 허브와 같음
2. 커넥터와 PHY(MAU) 회로는 MDI-X로 접속되어 있고, 트위스트 페어 케이블에서 신호가 들어오면 이것이 PHY(MAU) 회로의 수신 부분에 들어감
3. PHY(MAU) 회로에서 케이블을 흐르는 신호의 형식부터 공통의 신호 형식으로 변환한 후 신호는 MAC 회로로 들어감
4. 디지털 데이터로 변환한 후 패킷의 맨 끝에 있는 FCS를 대조하여 오류의 유무를 검사하고, 문제가 없으면 버퍼 메모리에 저장함(NIC와 거의 같으므로 각 스위칭 허버의 커넥터 안쪽에는 NIC와 같은 회로가 있다고 생각하면 됨 - 포트라 부름)
5. NIC에는 MAC주소가 할당되어 있지만, 스위칭 허브의 포트는 수신처 MAC 주소를 검사하지 않고 모든 패킷을 수신하여 버퍼 메모리에 저장하기 때문에 스위칭 허브의 포트에는 NIC 어댑터와 달리 MAC 주소가 할당되어 있지 않음
6. 패킷을 버퍼 메모리에 저장하면 다음에 수신처 MAC 주소와 일치하는 것이 MAC 주소표에 등록되어 있는지 조사함
7. MAC 주소표에는 기기의 MAC 주소와 그 기기가 어느 포트에 존재하는지에 대한 정보가 등록되어 있음
8. 따라서 MAC 주소와 일치하는 포트에 패킷을 전송함

#### 스위치 회로의 구조

- 신호선이 격자모양으로 배치되고, 교점에 스위치가 있음
- 스위치를 전자적으로 개폐를 제어할 수 있고, 이 전자적 개폐를 통해 신호가 흐르는 대상을 제어함
- 입력측은 수신측 포트에, 출력측은 송신측 포트에 각각 접속되어 있음
- 이 스위치 회로를 경유하여 송신측의 포트에 패킷을 운반하면 MAC 회로나 PHY(MAU) 회로가 송신 동작을 실행하고 케이블에 신호가 흘러감
- 규칙에 따라 송수신 회로의 수신 부분에 신호가 흘러들어오는지 확인하거나 송신중인지 확인, 충돌에 따른 재밍 신호를 보내는 부분도 NIC와 같음

### MAC 주소 테이블을 등록 및 갱신

- 스위칭 허브는 패킷을 중계할 때 MAC 주소표의 내용을 갱신하는 동작도 실행함
  - 패킷을 수신했을 때 송신처 MAC 주소를 조사하고, 이것을 수신한 입력 포트 번호와 하나의 세트로 MAC 주소표에 등록하는 것 -> 패킷이 들어온 포트의 앞에 패킷을 송신한 기기가 있을 것이므로 송신처 주소를등록해 두면 MAC 주소로 갈 패킷을 수신했을 때 이것이 존재하는 포트에 중계할 수 있음
  - MAC 주소표에 등록되어 있는 내용을 지움 -> 기기를 이동한 경우의 불편함을 방지하기 위함

### 예외적인 동작

Ex) 주소표에서 일치하는 행을 찾아냈을 때 주소표에 등록되어 있는 송신 포트가 패킷을 수신한 포트와 같을 때 -> 스위칭 허브에 리피터 허브가 접속되어 있는 경우에 발생

1. PC A에서 보낸 패킷은 리피터 허브에 도착하고, 여기에서 모든 포트에 뿌려져서 스위칭 허브와 PC B에 도착함.
2. 이때 스위칭 허브가 패킷을 중계하면 같은 패킷을 리피터 허브에 반송
3. 그러면 리피터 허브에서 뿌려지고 PC A와 PC B에 패킷이 도착한 후 PC B에 두 개의 같은 패킷이 도착함
4. 이런 상태로는 통신 동작이 제대로 이루어지지 않으므로 스위칭 허브는 패킷을 수신한 포트와 송신하는 포트가 같은 경우 패킷을 중계하지 않고 폐기함

### 전이중 모드에서 송신과 수신을 동시에 실행함

- 전이중 모드 - 송신과 수신을 동시에 실행할 수 있는 성질도 리피터 허브에는 없는 스위칭 허브의 특징
- 리피터 허브를 사용하는 경우 여러 대의 컴퓨터가 동시에 송신 동작을 개시하면 리피터 허브의 내부에서 신호가 뒤섞여서 신호가 파괴됨 -> 충돌(스위칭 허브에서는 일어나지 않음)
- 트위스트 페어 케이블의 신호선은 송신용과 수신용으로 나뉘어져 있으므로 트위스트 페어 케이블의 송수신 도중에 신호가 충돌하지 않음
- 이더넷은 신호가 흐르고 있을 때는 이것이 끝나기를 기다렸다가 송신 동작을 실행하므로 송신과 수신을 동시에 할 수 없음 -> 이더넷의 규칙을 개정하여 신호가 흐르고 있어도 상관하지 않고 송신해도 좋다는 동작 모드 추가(전이중 모드)

### 최적의 전송 속도로 보내는 자동 조정

- 자동 조정(auto negotiation) - 접속한 상대가 전이중 모드를 지원하는지 검출하고 동작 모드를 자동으로 전환하는 기능. 동작 모드뿐만 아니라 상대의 전송 속도를 검출하여 전송 속도도 자동으로 전환
- 이더넷은 데이터가 흐르고 있지 않을 때는 링크 펄스라는 펄스형의 신호를 흘림 -> 상대가 올바르게 작동하는지, 케이블이 단선되지 않았는지 등의 사항을 확인할 수 있음
- 자동 조정은 특정 패턴으로 펄스 신호를 송신하여 최적의 조합을 선택해 자기 자신을 설정함

### 스위칭 허브는 복수의 중계 동작을 동시에 실행함

- 스위칭 허브는 수신처 MAC 주소의 기기가 존재하는 포트 이외에는 송신 동작을 실행하지 않으므로 다른 포토는 빈 상태가 됨
- 특정 포트에 패킷이 흐르고 있을 때 다른 포트는 빈 상태가 되고, 여기에 별도의 패킷을 흘릴 수 있으며 결과적으로 동시에 여러 개의 패킷을 중계할 수 있음
- 리피터 허브쪽은 들어온 신호를 모든 포트에서 뿌리므로 동시에 두 개 이상의 신호가 들어오면 패킷이 충돌하기 때문에 복수의 신호를 동시에 흘릴 수 없음



## 라우터의 패킷 중계 역할

### 라우터의 기본

- 리피터 허브나 스위칭 허브를 경유한 패킷은 결국 라우터에 도착하고, 라우터에서 다음 라우터로 중계됨
- 라우터의 내부구조
  - 중계 부분 - 패킷의 중계 대상을 판단하는 동작을 담당
  - 포트 부분 - 패킷을 송수신하는 동작을 담당
- 라우터의 포트 부분은 LAN 이외의 통신 기술을 지원하는 것도 있음.(ADSL, FTTH, 전용회선, 무선 LAN 등등..)

1. 포트 부분에서 패킷을 수신(포트 부분의 통신 기술의 규칙을 따름)
2. 중계 부분에서 받은 패킷의 IP 패킷에 기록되어 있는 수신처 IP 주소와 중계 대상을 등록한 표를 대조하여 중계 대상을 판단함
3. 중계 대상측의 포트로 패킷을 옮기고 포트 부분의 하드웨어 규칙에 따라 패킷 송신 동작을 실행함

스위칭 허브는 들어온 패킷을 전송하기만 하고 자신이 송신처나 수신처가 되지 않는데 비해 라우터는 라우터의 포트 부분이 수신처가 되어 이더넷의 수신 동작을 실행함

### 경로표에 등록된 정보

- 스위칭 허브는 MAC 헤더에 기록되어 있는 수신처 MAC 주소로 중계 대상을 판단하지만, 라우터는 IP 헤더에 기재되어 있는 수신처 IP 주소로 중계 대상을 판단

- 라우팅 테이블의 구성표

  | 목적지       | 넷마스크          | 게이트웨이 | 인터페이스 | 메트릭  |
  | --------- | ------------- | ----- | ----- | ---- |
  | 10.10.1.0 | 255.255.255.0 | -     | e2    | 1    |

- 목적지 - 목적지의 정보로, 서브넷 자체를 나타내는 주소, 즉 네트워크 번호 부분의 비트에만 값이 있고 호스트 번호 부분의 비트 값은 모두 0으로 되어 있는 IP 주소

- 주소 집약 - 몇 개의 서브넷을 모아서 한 개의 서브넷으로 간주한 후 묶은 서브넷을 경로표에 등록할 수 있음

  10.10.1.0/24, 10.10.2.0/24, 10.10.3.0/24라는 3개의 서브넷이 있다고 가정할 때 라우터의 원칙상으로는 별도로 등록하는게 원칙이지만 어느 서브넷에 패킷을 건넬 때도 같은 라우터에 중계하기 때문에 10.10.0.0/16이라는 서브넷으로 통합하여 간주함

- 게이트웨이와 인터페이스 - 패킷의 중계대상

- '목적지' 항목과 '넷마스크' 항목에서 해당 행을 찾아내면 '인터페이스' 항목에 등록되어 있는 인터페이스(포트)에서 '게이트웨어' 항목에 등록되어 있는 IP 주소를 가진 라우터에 대해 패킷을 중계함

- 메트릭 - 목적지 IP 주소에 기록되어 있는 목적지가 가까운지, 먼지를 나타냄

- 라우터가 경로표에 경로 정보를 등록하거나 갱신하는 동작은 패킷을 중계하는 동작과 분리되어 있어, 패킷을 중계할 때 경로표의 내용에 손대지 않음

- 라우터의 경로표에 겨올 정보를 등록하는 방법

  1. 사람이 수동으로 경로 정보를 등록/갱신
  2. 라우팅 프로토콜이라는 구조를 사용하여 라우터들끼리 경로 정보를 교환하고 라우터가 자체에서 경로표에 등록

### 라우터의 패킷 수신 동작

- 라우터의 포트 부분의 구조는 PC의 NIC와 거의 같으므로 패킷을 수신하여 버퍼 메모리에 저장하는 부분까지의 동작도 거의 같음

1. 신호가 커넥터 부분에 도착하면 안쪽에 있는 PHY(MAU)회로와 MAC회로에서 신호를 디지털 데이터로 변환함
2. 패킷 끝부분의 FCS를 대조하여 오류의 유무를 점검하고, 정상이면 MAC 헤더의 수신처 MAC 주소가 자신에게 해당하는지 조사하여 해당하면 패킷을 수신 버퍼 메모리에 저장

### 경로표를 검색하여 출력 포트를 발견

- 라우터는 패킷 수신 동작이 끝나면 맨 앞의 MAC 헤더를 폐기함 -> MAC헤더의 역할은 해당 라우터에 패킷을 건네주는 것이기 때문
- IP 헤더의 내용을 보고 패킷 중계 동작에 들어감.
  1. 경로표에서 중계 대상을 조사함(넷마스크의 네트워크 번호의 비트 수를 판단하여 네트워크 번호 부분만 비교)
  2. 대상이 여러 개 있을 경우 네트워크 번호의 비트수가 가장 긴 것을 찾음
  3. 네트워크 번호의 길이가 같은 것이 여러 개 존재할 경우에는 메트릭 값으로 판단. (작은 쪽이 가까이 있는 것이므로 값이 작은 쪽을 중계 대상으로 선택)
  4. 하나도 발견하지 못하면 패킷을 폐기하고 ICMP 메시지로 송신처에 이 사실을 통지함
- 스위칭 허브는 많아야 수천 대 정도의 그다지 크지 않은 네트워크를 가정하여 만든 것
- 라우터가 가정하는 범위는 전세계를 커버하고도 남는 엄청난 규모이기 때문에 중계 대상이 분명하지 않은 패킷을 폐기

### 해당하는 경로가 없는 경우에 선택하는 기본 경로

- '넷마스크' 항목을 0.0.0.0으로 해두면 모든 주소에 일치함
- 해당 행의 '게이트웨이' 항목에 인터넷으로 나가는 라우터를 등록해두면 다른 행에 해당하는 값이 없는 경우 패킷을 그곳으로 중계함
- 이를 **기본 경로**라고 하며 여기에 등록한 라우터를 **기본 게이트웨이**라고 함

### 패킷은 유효 기간이 있음

경로표에서 중계 대상을 찾아내면 패킷을 출력측의 포트로 옮기고 여기에서 송신하는데, 그 전에 다음과 같은 일을 함

- TTL(Time To Live)라는 IP 헤더의 필드를 갱신
- 라우터를 경유할 때마다 1씩 줄이다가 0이 되면 패킷을 폐기
- 송신처에서 처음 패킷을 송신할 때 64 또는 128이라는 값을 설정하고 나서 그 수만큼 라우터를 경유하면 패킷의 수명이 다한 것으로 간주

### 큰 패킷은 조각 나누기 기능으로 분할

- 라우터의 포트 부분은 이더넷뿐만 아니라 이더넷 이외의 LAN이나 통신 회선의 경우도 있음
- 회선이나 LAN의 종류에 따라 패킷의 최대 길이가 달라지므로 출력 포트측의 패킷의 최대 길이가 입력측보다 작은 경우도 있음
- 이 경우에는 IP 프로토콜에 규정된 fragmentation이라는 방법을 사용하여 패킷을 분할하고, 패킷의 길이를 짧게 만든 후 중계함
  1. 출력측의 MTU를 조사하여 중계하는 패킷을 그대로 출력측에서 송신할 수 있는지 조사함
  2. 출력측의 MTU가 작은 경우에는 여기에 저장할 수 있는 크기로 패킷을 분할하는데, 그 전에 IP 헤더의 플래그 필드를 조사하여 분할해도 좋을지 확인
  3. 분할 불가로 되어 있으면 패킷을 폐기하고 ICMP 메시지로 송신처에 통지
  4. 분할 가능하다면 출력측의 MTU에 맞춰 데이터 부분을 맨 앞부분부터 차례대로 잘라냄(TCP 헤더 이후의 부분을 분할 대상 데이터로 간주)
  5. 데이터를 분할하면 IP 헤더를 덧붙임

### 라우터의 송신 동작은 컴퓨터와 같음

송신 전의 일이 끝나면 패킷의 송신 동작으로 넘어감. 이 때의 동작은 출력측의 포트에 따라 다름

1. MAC 헤더의 맨 앞에 있는 목적지 MAC 주소 필드에 값을 설정하기 위해 경로표의 '게이트웨이' 항목에서 패킷을 건네줄 상대를 판단
2. '게이트웨이' 항목에 IP 주소가 쓰여있으면 이 IP 주소가 건네줄 상대이고, 이곳이 비어있으면 IP 헤더의 목적지 IP 주소가 건네줄 상대가 됨
3. 이를 통해 상대의 IP 주소가 결정되면 ARP로 IP 주소에서 MAC 주소를 조사하고 결과를 수신처 MAC 주소로 설정함
4. 라우터에도 ARP 캐시가 있으므로 먼저 ARP 캐시를 찾아보고, 없으면 ARP로 조회를 보내 MAC 주소를 조회함
5. 송신처 MAC 주소 필드를 출력측의 포트에 할당된 MAC 주소를 설정함. + 타입 필드에 0800(16진수)을 설정
6. 패킷을 전기 신호로 변환하여 포트에서 송신함. (반이중 전이중 확인하고 등등..)
7. 출력측의 포트가 이더넷이면 송신한 패킷은 스위칭 허브를 경유하여 다음 라우터에 도달함
8. 반복 후 도착

### 라우터와 스위칭 허브의 관계

- MAC 헤더를 부가하여 패킷을 송신한다는 것은 이더넷의 패킷의 데이터 부분에 IP의 패킷을 넣고 이더넷의 원리로 다음 라우터까지 운반한다는 것
- IP라는 구조는 스스로 패킷을 운반하는 수단이 없으므로 패킷을 운반할 때는 이더넷에 의뢰하여 운반함
- **라우터는 패킷을 운반하는 일을 스위칭 허브에 의뢰함**
- 이는 IP와 디어넷이라는 구조를 그대로 표현한 '순수한' 라우터나 스위칭 허브를 가정하고 있음. (실제 라우터에는 스위칭 허브를 내장한 기종이 있음)
- IP가 이더넷에 의뢰하는 것은 최종 목적지까지 패킷을 운반하는 것이 아니라 다음 라우터에 패킷을 운반하는 것
-  MAC 헤더를 만들 때 IP 경로표에서 다음 라우터의 IP 주소를 조사하고, 여기에서 ARP로 조사한 MAC 주소를 수신처 MAC 주소에 기록함. 이것이 다음 라우터까지 패킷을 운반하도록 이더넷에 의뢰하는 것을 나타냄
- 따라서, 통신 상대까지 패킷을 전달하는 전체의 동작은 IP(라우터)가 담당하고, 이 동작을 할 때 다음 라우터까지 패킷을 운반하는 부분은 이더넷(스위칭 허브)이 담당함



## 라우터의 부가 기능

### 주소 변환으로 IP 주소를 효율적으로 이용함

- 1990년대에 들어 인터넷이 일반에게 공개되자 급속하게 접속 대수가 늘어나기 시작하면서 가까운 장래에 할당한 주소가 없어져버린다는 예측이 나옴

- 완전히 별개로 독립된 사내 네트워크는 서로 패킷이 왕래할 리가 없으므로 문제가 일어나지 않음

- 주소 부족에 대처하기 위하여 이 성질을 이용함.

- 단 사내 네트워크여도 자기 편한대로 주소를 할당하면 문제가 일어날 수 있으므로 특정 주소를 사내용으로 사용한다는 규칙을 세웠음

- 이러한 규칙에 기초한 사내용 주소는 **프라이비트 주소**로, 이전의 고유한 주소는 **글로벌 주소**로 부름

  ```c++
  10.0.0.0 ~ 10.255.255.255
  172.16.0.0 ~ 172.31.255.255
  192.168.0.0 ~ 192.168.255.255
  ```

- 이는 미사용의 글로벌 주소로, 프라이비트 주소를 위해 위 글로벌 주소는 할당해놓지 않음

- 사내 네트워크를 인터넷에 접속할 때는 다음과 같은 계층으로 구성해야 함

  인터넷 - 공개 서버용 LAN - 라우터(주소 변환의 구조 넣음) - 사내 네트워크

- 공개용 서버쪽에는 글로벌 주소를 할당하고 인터넷과 직접 통신해야 하는데, 이 부분은 기존의 방법이며 사내 네트워크에는 프라이비트 주소를 할당하고 인터넷과는 직접 패킷을 주고받지 않도록 특별한 구조를 사용하여 접속하는데, 이 구조가 주소 변환임

### 주소 변환의 기본 동작

- 주소 변환의 구조는 패킷을 중계할 때 IP 헤더에 기재된 IP 주소와 포트 번호를 바꿔쓰는 것임
- 먼저 TCP의 접속 동작에서 최초로 흐르는 패킷을 인터넷에 중계할 때 송신처의 IP 주소를 프라이비트 주소에서 글로벌 주소로 바꿔씀
- 여기서 사용하는 글로벌 주소는 주소 변환 장치의 인터넷측에 있는 포트에 할당된 주소로, 이것과 동시에 포트 번호도 바꿔씀
- 그리고 바꿔쓰기 전의 프라이비트 주소와 포트 번호, 바꿔쓴 후의 글로벌 주소와 포트 번호를 한 세트로 하여 주소 변환 장치 내부에 있는 대응표에 기록함
- 그 후 패킷을 주고받을 때는 대응표에서 프라이비트 주소와 글로벌 주소의 대응 관계를 조사하여 주소와 포트 번호를 바꿔쓰고 나서 패킷을 중계함
- 이후 인터넷에 대한 접속 동작이 끝나면 대응표에 등록한 것을 삭제함

### 포트 번호를 바꿔쓰는 이유

- 초기의 주소 변환은 포트 번호 바꿔쓰기를 실행하지 않고 주소만 바꿔썼음
- 이 방법으로도 사내와 인터넷에서 주고받기가 가능하면서 구조가 간단함
- 그러나, 프라이비트 주소와 글로벌 주소가 1대 1로 대응해서 인터넷에 접속하는 대수만큼 글로벌 주소가 필요함 -> 따라서 포트 번호도 바꿔쓰는 방법을 통해 효율을 높임

### 인터넷에서 회사로 액세스함

- 사내에서 인터넷으로 액세스하는 패킷을 중계할 때는 대응표에 송신처의 프라이비트 주소와 포트 번호가 등록되어 있지 않아도 패킷을 중계할 수 있음 -> 바꿔쓰는 글로벌 주소는 주소 변환 장치(라우터)에 할당되어 있고, 포트 번호는 적당히 비어있는 것을 사용하면 되므로 주소 변환 장치 자체에서 적당히 판단할 수 있기 때문
- 그러나 인터넷에서 사내로 패킷을 중계할 때는 대응표에 등록되어 있지 않으면 중계할 수 없음
- 즉 사내에서 의도적으로 인터넷에 액세스하지 않는 한 인터넷측에서 사내에 패킷을 보낼 수 없음 -> 부정 침입을 방지하는 효과가 있음

### 라우터의 패킷 필터링 기능

- 패킷 필터링 기능 - 패킷을 중계할 때 MAC 헤더, IP 헤더, TCP 헤더에 기록되어 있는 내용을 조사하여 그것이 사전에 설정한 조건에 합치되면 패킷을 중계하거나 폐기하는 동작을 실행할 뿐
- 대부분의 방화벽이라는 기기나 소프트웨어는 이 원리를 이용하여 부정 침입을 방지함