# 3. 네트워크 통신하기

## 유니캐스트, 멀티캐스트, 브로드캐스트, 애니캐스트

### 유니 캐스트

- 1:1 통신방식
- 출발지와 목적지가 1:1로 통신

### 브로드캐스트

- 1:모든통신
- 동일 네트워크에 존재하는 모든 호스트가 목적지

### 멀티캐스트

- 1:그룹통신
- 하나의 출발지에서 다수의 특정 목적지로 데이터 전송

### 애니캐스트

- 1:1통신(목적지는 동일 그룹 내의 1개 호스트)
- 다수의 동일 그룹 중 가장 가까운 호스트에서 응답
- IPv4에서는 일부 기능 구현, IPv6은 모두 구현 가능

### BUM 트래픽

- U(Unknown Unicast) - 목적지 주소는 명확히 명시되어 있지만 네트워크에서의 동작은 브로드캐스트와 같을 때(스위치가 목적에 대한 주소를 학습하지 못한 상황에서 패킷을 모든 포트로 전송하는 유니캐스트)
- 유니캐스트이지만 동작 방식은 브로드캐스트에 가까움.
- 유니캐스트이므로 전달받는 모든 단말 NIC에서 도착지 주소를 확인하고 자신이 목적지가 아니므로 패킷을 버림->네트워크상에서 불필요한 BUM트래픽이 많아지면 네트워크 성능이 저하될 수 있음



## MAC주소

Media Access Control의 줄임말로 2계층에서 통신을 위해 네트워크 인터페이스에 할당된 고유 식별자.

### MAC 주소 체계

- MAC주소는 변경할 수 없도록 하드웨어에 고정되어 출하되므로 네트워크 구성 요소마다 다른 주소를 갖고 있음.
- 48비트의 16진수 12자리로 표현됨.
- 앞 24비트(OUI값)는 제조사 코드, 뒤 24비트(UAA)는 각 제조사에서 자체적으로 할당하여 네트워크에서 각 장비를 구분할 수 있게 해줌
- MAC주소는 동일 네트워크에서만 중복되지 않으면 동작하는 데 문제가 없음
- 네트워크 통신을 할 때 네트워크가 달라 라우터의 도움을 받아야 할 경우, 라우터에서 다른 네트워크로 넘겨줄 때 출발지와 도착지의 MAC주소가 변경되므로 네트워크를 넘어가면 기존 출발지와 도착지 MAC주소를 유지하지 않음



### MAC 주소 동작

- NIC는 자신의 MAC주소를 가지고 있고 전기 신호가 들어오면 2계층에서 데이터 형태(패킷)로 변환하여 내용을 구분한 후 도착지 MAC주소를 확인함.

- 도착지 MAC주소가 자신이 갖고 있는 MAC주소와 다르면 패킷을 폐기

- 목적지 주소가 자기 자신이거나 브로드캐스트, 멀티캐스트와 같은 그룹 주소라면 처리해야 할 주소로 인지해 패킷 정보를 상위 계층으로 넘겨줌(NIC에서 폐기하는 경우와 달리 본인의 주소, 브로드캐스트 주소는 OS가 처리해야 하므로 시스템에 부하가 작용)

- 무차별 모드(Promiscuous Mode)

  다른 목적지를 가진 패킷을 분석하거나 수집해야 할 경우, 무차별 모드로 NIC를 구성하면 자신의 MAC주소와 상관없는 패킷이 들어와도 이를 분석할 수 있도록 메모리에 올려 처리할 수 있게 함(와이어샤크)

- MAC주소는 단말에 종속되지 않고 NIC에 종속됨. 단말은 NIC를 여러 개 가질 수 있으므로 MAC주소도 여러 개 가질 수 있음



## IP주소

IP주소를 포함한 다른 프로토콜 스택의 3계층 주소의 특징

- 사용자가 변경 가능한 논리 주소
- 주소에 레벨이 있음. 그룹을 의미하는 네트워크 주소와 호스트 주소로 나뉨.

### IP 주소 체계

- 네트워크 주소 - 호스트들을 모은 네트워크를 지칭하는 주소. 네트워크 주소가 동일한 네트워크를 로컬 네트워크라고 함
- 호스트 주소 - 하나의 네트워크 내에 존재하는 호스트를 구분하기 위한 주소
- 이 둘을 구분하는 경계점이 고정되어 있지 않음.
- 필요한 호스트 IP 개수에 따라 네트워크의 크기를 다르게 할당할 수 있는 클래스 개념을 도입함
  - A클래스 - 약 1600만개의 IP주소를 가질 수 있음, 첫 번째 옥텟에 네트워크 주소와 호스트 주소를 나누는 구분자가 존재
  - B클래스 - 약 6만 5천개, 두 번째 옥텟에 네트워크 주소와 호스트 주소를 나누는 구분자가 존재
  - C클래스 - 약 250개의 IP주소를 가질 수 있음, 세 번째 옥텟에 네트워크 주소와 호스트 주소를 나누는 구분자가 존재
  - D클래스 - 멀티캐스트
  - E클래스 - 예약(Reserved for futures)
  - 구분자 - 서브넷 마스크라고 함.
- 클래스 구분법(맨 앞 옥텟 주소)
  - A클래스 - 0~127의 범위(127은 루프백)
  - B클래스 - 128~191
  - C클래스 - 192~223
  - D클래스 - 224~239
- 클래스 기반의 네트워크 분할 기법은 과거에 사용했던 개념으로 현재는 보다 네트워크 주소를 세밀하게 분할하고 할당하기 위해 필요한 네트워크의 크기에 맞추어 1비트 단위로 네트워크를 상세히 분할하는 방법을 사용

### 클래스풀과 클래스리스

클래스 기반의 IP 주소 체계(네트워크 주소와 호스트 주소를 구분짓는 구분자(서브넷 마스크)가 필요없었음)

#### 클래스리스 네트워크의 등장

- 기존 클래스풀 기반의 주소 체계는 확장성과 효율성을 모두 잡는 좋은 주소체계였지만 기하급수적으로 늘어나는 IP 주소 요구를 감당하기에는 부족했음
- IPv4의 가장 큰 문제는 상위 클래스를 할당받은 조직에서 이 주소들을 제대로 사용하지 못하면서 낭비하는 것
- 서브넷 마스크 - 255.255.0.0과 같은 형태로 사용되며 255가 네트워크 주소 부분, 0은 호스트 주소 부분으로 구분됨

### 서브네팅

원래 부여된 클래스의 기준을 무시하고 새로운 네트워크-호스트 구분 기준을 사용자가 정해 원래 클래스풀 단위의 네트워크보다 더 쪼개 사용하는 것

- Ex) 서브넷이 255.255.255.192인 경우 11111111 11111111 11111111 11000000이 되는데 1이 연속되어있는 부분을 전부 네트워크로 사용하고 실제 호스트는 6비트만을 사용하는 것

- 네트워크 디자인 단계에서 네트워크 설계자가 네트워크를 효율적으로 어떻게 분할할 것인지 계획할 때나 이미 분할된 네트워크에서 사용자가 자신의 네트워크와 원격지 네트워크를 구분해야 하는 경우 고민해야 함

- 네트워크 사용자 입장

  네트워크에서 사용할 수 있는 IP 범위 파악. 기본 게이트웨이와 서브넷 마스크 설정이 제대로 되어 있는지 확인

- 네트워크 설계자 입장

  네트워크 설계 시 네트워크 내에 필요한 단말을 고려한 네트워크 범위 설계

#### 네트워크 사용자의 서브네팅

- 주어진 네트워크 범위 밖의 IP를 할당하거나 서브넷 마스크를 잘못 입력하면 로컬 네트워크의 특정 범위에 속해있는 단말과 통신에 문제가 생기거나 외부 네트워크 전체에 통신하지 못하는 상황이 발생

- 서브네팅 방법

  IP주소 103.9.32.146 -> 01100111 00001001 00100000 10010010

  서브넷 255.255.255.192 -> 11111111 11111111 11111111 11000000

  &연산을 통해 네트워크 주소, 브로드캐스트 주소, 첫 번째 주소, 마지막 주소를 알아낼 수 있음.

  위의 경우는 네트워크 주소(첫 번째 숫자) - 103.9.32.128, 브로드캐스트 주소  - 103.9.32.191, 유효 IP 범위 - 103.9.32.129~103.9.32.190

#### 네트워크 설계자 입장

- 서브넷된 하나의 네트워크에 IP를 몇 개나 할당해야 하는가?
- 그리고 서브넷된 네트워크가 몇 개나 필요한가?를 고민해야 함.
- Ex - 12개의 지사가 있고 12대의 IP가 필요한 PC 등이 운영될 예정일 때
  1. 서브넷된 하나의 네트워크에 12개 IP를 할당해야 함
  2. 네트워크는 2진수의 배수로 커지므로 4, 8, 16, 32, 64, 128, 256개 단위로 네트워크를 할당할 수 있음. 12개의 IP를 수용할 수 있는 가장 작은 네트워크는 16개이므로 16개짜리 네트워크 할당(네트워크 주소와 브로드캐스트 주소로 사용할 2개 IP를 제외해야 하므로 실질적으로는 14개 사용가능)
  3. 16개짜리 네트워크 12개를 확보. 16의 배수를 0부터 나열해 네트워크 주소를 확인
- 네트워크를 설계할 때 가능하면 사설 IP대역을 사용해 충분한 IP대역을 사용하는 것이 좋음.

### 공인 IP와 사설 IP

공인 IP - 인터넷에 접속하려면 IP주소가 있어야 하고 이 IP는 전 세계에서 유일해야 하는 식별자

사설 IP주소 - 인터넷에 연결하지 않고 개인적으로 네트워크를 구성한다면 공인 IP 주소를 할당받지 않고도 네트워크를 구축할 수 있음. 이 때 사용하는 주소

- 인터넷에 접속하려면 통신사업자로부터 IP주소를 할당받거나 IP 할당기관에서 인터넷 독립주소(ASN)을 할당받은 후 독립 IP를 할당받아야 하므로 절차가 복잡함
- 인터넷에 접속하지 않거나 NAT기술을 사용할 경우에는 사설 IP주소를 이용할 수 있음(RFC에 명시되어있음)
- 다른 기관에서 사용하는 공인 IP를 회사 내부에서 사용할 경우, 해당 IP로의 접근이 불가능함.
- 규모가 큰 엔터프라이즈 네트워크에서는 대부분 A클래스 크기인 10.0.0.0/8 네트워크를 사용
- 규모가 작은 네트워크를 위해서는 C클래스 192.168.x.0/24를 사용.(공유기에서 가장 많이 사용되는 기본 IP가 192.168.0.1인 이유)
- 모바일 디바이스에서는 가장 많이 사용되는 10점대 A클래스와 192.168x0/24번대 C클래스와 겹치지 않도록 B클래스인 172.x.x.x 네트워크를 이용해 테더링 기능을 제공
- Bogon IP - IP주소를 할당하는 최상위 기구인 IANA가 여러 가지 목적으로 예약해놓아 공인 IP로 할당하지 않는 주소



## TCP와 UDP

목적지 단말 안에서 동작하는 여러 애플리케이션 프로세스 중 통신해야 할 목적지 프로세스를 정확히 찾아가고 패킷 순서가 바귀지 않도록 잘 조합해 원래 데이터를 잘 만들어내기 위한 역할

### 4계층 프로토콜(TCP, UDP)과 서비스 포트

- TCP/IP 프로토콜 스택에서 4계층은 TCP와 UDP가 담당. 
- 패킷을 분할하고 조합하기 위해 TCP프로토콜에서는 시퀀스 번호와 ACK번호를 사용
- TCP/IP 프로토콜 스택에서 4계층의 상위 프로토콜 지시자는 포트 번호임.
- 웰노운 포트 - HTTP TCP 80, HTTPS TCP 443, SMTP TCP 25와 같이 잘 알려진 포트
- Registered Port - 1024~49151의 범위로 다양한 애플리케이션에 포트 번호를 할당받기 위한 범위. IANA에 신청하면 등록되어 관리되지만 공식번호와 비공식 번호가 혼재되어있고, 사설 포트 번호로 사용되기도 함.

### TCP

- 신뢰할 수 없는 공용망에서도 정보유실 없는 통신을 보장하기 위해 세션을 안전하게 연결하고 데이터를 분할하고 분할된 패킷이 잘 전송되었는지 확인하는 기능이 있음.

#### 패킷 순서, 응답 번호

TCP에서는 분할된 패킷을 잘 분할하고 수신 측이 잘 조합하도록 패킷에 순서를 주고 응답 번호를 부여함.

- 시퀀스 번호 - 패킷에 순서를 부여하는 것
- ACK번호 - 응답 번호를 부여하는 것

1. 출발지에서 시퀀스 번호를 0으로 보냄
2. 수신 측에서는 0번 패킷을 잘 받았다는 표시로 응답번호(ACK)에 1을 적어 응답함. 이 때 수신 측에서는 자신이 처음 보내는 패킷이므로 자신의 패킷에 시퀀스 번호 0을 부여함.
3. 이 패킷을 받은 송신 측은 시퀀스 번호를 1로, ACK 번호는 상대방의 0번 시퀀스를 잘 받았다는 의미로 시퀀스 번호를 1로 부여해 다시 송신함

#### 윈도 사이즈와 슬라이딩 윈도

- 송신자와 수신자가 먼 거리에 떨어져 있으면 왕복 지연시간이 늘어나므로 응답을 기다리는 시간이 더 길어짐
- 따라서 데이터를 보낼 때 패킷을 하나만 보내는 것이 아니라 많은 패킷을 한꺼번에 보내고 응답을 하나만 받음
- **윈도 사이즈** - 가능하면 최대한 많은 패킷을 한꺼번에 보내는 것이 효율적이지만 네트워크 상태가 안 좋으면 패킷 유실 가능성이 커지므로 적절한 송신량을 결정해야 하는데 한 번에 데이터를 받을 수 있는 데이터 크기.
- **슬라이딩 윈도** - 윈도 사이즈를 조절하는 것
- TCP헤더에서 윈도 사이즈로 표현할 수 있는 최대 크기는 2의 16승.
- 실제로 64k만큼 윈도 사이즈를 가질 수 있지만 이 사이즈는 회선의 안정성이 높아지고 고속화되는 현대 네트워크에서는 너무 작은 숫자임.
- 따라서 64K보다 대폭 늘려 통신하는데 TCP헤더는 변경이 불가능하므로 헤더 사이즈를 늘리지 않고 뒤의 숫자를 무시하는 방법으로 윈도 사이즈를 증가시켜 통신함.(10, 100배로 윈도 사이즈가 커짐)
- 데이터에 유실이 발생하면 윈도 사이즈를 절반으로 떨어뜨리고 정상적인 통신이 되는 경우 서서히 하나씩 늘림

#### 3방향 핸드셰이크

패킷 네트워크에서는 동시에 많은 상대방과 통신하므로 정확한 통신을 위해서는 통신 전, 각 통신에 필요한 리소스를 미리 확보하는 작업이 중요. TCP에서는 3번의 패킷을 주고받으면서 통신을 준비하므로 **3방향 핸드셰이크**라고 함.

- Listen - 서비스를 제공하기 위해 클라이언트의 접속을 받아들일 수 있는 서버의 상태
- SYN-SENT - 클라이언트에서 통신을 시도할 때 Syn패킷을 보내는데 이 때의 클라이언트의 상태.
- SYN-RECEIVE - 클라이언트의 Syn을 받아 Syn, Ack로 응답하는 서버의 상태
- ESTABLISHED - 서버 또는 클라의 Syn, Ack응답을 받은 클라이언트 또는 서버의 상태

Flag - 3방향 핸드셰이크 과정에서 어떤 패킷이 새로운 연결 시도이고 기존 통신에 대한 응답인지 구분하기 위해 넣는 값

TCP의 Flag

- SYN - 연결 시작 용도로 사용. 연결이 시작될 때 SYN플래그에 1로 표시해 보냄
- ACK - ACK번호가 유효할 경우, 1로 표시해 보냄. 초기 SYN이 아닌 모든 패킷은 기존 메시지에 대한 응답이므로 ACK 플래그가 1로 표기됨
- FIN - 연결 종료시 1로 표시됨. 데이터 전송을 마친 후 정상적으로 양방향 종료 시 사용됨
- RST - 연결 종료시 1로 표시됨. 연결 강제 종료를 위해 연결을 일방적으로 끊을 때 사용됨
- URG - 긴급 데이터인 경우 1로 표시해 보냄
- PSH - 서버 측에서 전송할 데이터가 없거나 데이터를 버퍼링 없이 응용 프로그램으로 즉시 전달할 것을 지시할 때 사용됨

### UDP

4계층 프로토콜이 가져야 할 특징이 거의 없음

- 음성 데이터나 실시간 스트리밍과 같이 시간에 민감한 프로토콜이나 애플리케이션을 사용하는 경우나 사내 방송이나 증권 시세 데이터 전송에 사용되는 멀티캐스트처럼 단방향으로 다수의 단말과 통신해 응답을 받기 어려운 환경에서 주로 사용
- UDP에서 첫 데이터는 리소스 확보를 위해 인터럽트를 거는 용도로 사용되고 유실됨.
- 따라서 UDP 프로토콜을 사용하는 애플리케이션이 대부분 이런 상황을 인지하고 동작하거나 연결 확립은 TCP프로토콜을 사용하고 애플리케이션끼리 모든 준비를 마친 후 실제 데이터만 UDP를 이용하는 경우가 대부분임



## ARP

실제로 통신은 IP주소 기반으로 일어나고 MAC주소는 상대방의 주소를 자동으로 알아내 통신하게 됨. 이 때 상대방의 MAC주소를 알아내기 위해 사용되는 프로토콜이 ARP

### ARP란?

3계층 논리적 주소와 2계층 물리적 주소 사이에 관계가 없는 프로토콜을 연결시켜 주는 프로토콜

- 호스트에서 아무 통신이 없다가 처음 통신을 시도하면 패킷을 바로 캡슐화 할 수 없음
- 통신을 시도할 때 출발지와 목적지 IP주소는 미리 알고 있어 캡슐화하는 데 문제가 없지만 상대방의 MAC주소를 알 수 없어 2계층 캡슐화를 수행할 수 없음.
- 이 때 ARP브로드캐스트를 이용해 네트워크 전체에 상대방의 MAC주소를 질의함
- ARP브로드캐스트를 받은 목적지는 ARP프로토콜을 이용해 자신의 MAC주소를 응답함.
- ARP 프로토콜을 이용해 IP 주소와 MAC 주소를 매핑하면 "유형" 필드에 "동적"으로 표시됨

### ARP동작

1. 서버 A에서 서버 B로 ping을 보내려고 할 때, 서버 A에서는 3계층의 IP주소까지 캡슐화할 수 있지만 MAC주소를 모르기 때문에 정상적으로 패킷을 보낼 수 없음
2. 서버 A는 서버 B의 MAC주소를 알아내기 위해 ARP요청을 네트워크에 브로드캐스트함
3. ARP패킷을 네트워크에 브로드캐스트할 때 2계층 MAC주소는 출발지를 자신의 MAC으로, 도착지는 브로드캐스트(FF-FF-FF-FF-FF-FF)로 채우고 ARP 프로토콜 필드의 전송자 MAC과 IP주소에는 자신의 주소로, 대상자 IP 주소는 10.1.1.2를, 대상자 MAC주소는 00-00-00-00-00-00으로 채워 네트워크에 뿌림
4. 갈 때는 브로드캐스트, 받을때는 유니캐스트의 형식
5. 서버 A는 서버 B로부터 ARP응답을 받아 자신의 ARP 캐시 테이블을 갱신함. 이 ARP캐시테이블은 정해진 시간 동안 서버 B와의 통신이 없을 때까지 유지됨.

### GARP

- ARP가 상대방의 MAC주소를 알아내기 위해 사용되는 반면, GARP는 자신의 IP와 MAC주소를 알릴 목적으로 사용됨.
- 송신자 MAC은 자신의 MAC주소, 송신자 IP주소는 자신의 IP주소, 대상자 MAC 주소는 모두 0으로 표기, 대상자 IP 주소도 자신의 IP주소로 넣어 네트워크에 브로드캐스트 함.
- GARP를 사용하여 동일 네트워크에 자신의 IP 주소와 MAC주소를 알려주는 이유
  1. IP주소 충돌 감지
  2. 상대방(동일 서브넷 상의 다른)의 ARP 테이블 갱신
  3. HA(고가용성) 용도의 클러스터링, VRRP, HSRP

#### IP 주소 충돌 감지

IP충돌 때문에 통신이 안 되는 것을 예방하기 위해 자신에게 할당된 IP가 네트워크에서 이미 사용되고 있는지 GARP를 통해 확인함. 

#### 상대방(동일 서브넷에 있는)의 ARP 테이블 갱신

- 가상 MAC 주소를 사용하지 않는 데이터베이스 HA솔루션에서 주로 사용
- 데이터베이스 HA는 주로 두 데이터베이스 서버가 하나의 가상 IP주소로 서비스함.
- 두 대의 데이터베이스 중 한 대만 동작하고 나머지 한 대는 대기하는 액티브-스탠바이로 동작.
- 액티브 상태인 서버가 가상 IP주소 요청에 응답해 서비스하지만 MAC주소는 실제 MAC을 사용함
- 스탠바이 장비가 액티브 상태가 되면 GARP패킷을 네트워크에 보내 액티브 장비가 변경되었음을 알려줌으로서 스탠바이 장비로 패킷이 보내지는 현상을 막음

#### 클러스터링, FHRP

클러스터링 - 실제 MAC주소를 사용하지 않고 가상 MAC을 사용

- 네트워크에 있는 스위치 장비의 MAC 테이블 갱신이 목적
- 클러스터링에서 가상 MAC주소를 사용하는 경우, 단말은 ARP 정보를 가상 MAC주소로 학습하므로 단말의 ARP 테이블을 갱신할 필요가 없음
- 그러나 클러스터링 중간에 있는 스위치의 MAC 테이블은 마스터가 변경되었을 때 가상 MAC 주소의 위치를 적절히 찾아가도록 업데이트 해야하므로 마스터가 변경되는 시점에 MAC 테이블의 갱신이 필요
- 따라서 슬레이브가 마스터로 역할이 변경되면 GARP를 전송하고 스위치에서는 이 GARP를 통해 MAC 주소에 대한 포트정보를 새로 변경해 MAC 테이블을 갱신함

### RARP

반대로 동작하는 ARP, GARP처럼 ARP프로토콜 구조는 같지만 필드에 들어가는 내용이 다르고 원래 목적과 반대로 사용됨.

- IP주소가 정해져 있지 않은 단말이 IP 할당을 요청할 때 사용
- 나 자신의 MAC 주소는 알지만 IP가 아직 할당되지 않아 IP를 할당해주는 서버에 어떤 IP 주소를 써야 하는지 물어볼 때 사용됨
- 제한된 기능으로 인해 BOOTP와 DHCP로 대체되어 사용되지 않음



## 서브넷과 게이트웨이

게이트웨이 - 원격지 네트워크와의 통신에 사용하는 장비

### 서브넷과 게이트웨이의 용도

- 로컬 네트워크에서는 ARP 브로드캐스트를 이용해 도착지 MAC 주소를 학습할 수 있고 이 MAC 주소를 이용해 직접 통신할 수 있지만 원격 네트워크 통신은 네트워크를 넘어 전달되지 못하는 브로드캐스트의 성질 때문에 네트워크 장비의 도움이 필요함. -> 게이트웨이
- 기본 게이트웨이 - 게이트웨이에 대한 정보를 PC나 네트워크 장비에 설정하는 항목
- 기본 게이트웨이는 3계층 장비가 수행하고 여러 네트워크와 연결되면서 적절한 경로를 지정해주는 역할을 함
- 출발지와 목적지 네트워크가 동일한 LAN 내에서 통신하는 것인지, 서로 다른 네트워크 간의 통신인지에 따라 통신 방식이 달라지므로 출발지에서는 먼저 목적지가 자신이 속한 네트워크의 범위인지 확인하는 작업이 필요 -> 서브넷 마스크 사용

### 2계층 통신 vs 3계층 통신

단말 간을 연결해주는 네트워크 장비에서 2계층까지만 정보를 확인해 통신하고 ARP 요청을 보낼 때 직접 브로드캐스트를 이용하므로 이를 L2통신이라고 부름. 반면, 원격지 네트워크와 통신할 경우, 라우터와 같은 3계층 장비의 도움이 없으면 통신할 수 없음. 해당 패킷을 전송하는 네트워크 장비에서 3계층 정보까지 확인해야 하며 이것을 L3(3계층)통신이라고 함.

