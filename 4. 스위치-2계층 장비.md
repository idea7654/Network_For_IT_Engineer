# 4. 스위치 : 2계층 장비

스위치 - 네트워크 중간에서 패킷을 받아 필요한 곳에만 보내주는 네트워크의 중재자 역할을 함.  아무 설정 없이 네트워크에 연결해도 MAC 주소를 기반으로 패킷을 전달하는 기본 동작을 수행할 수 있음.

PDU - 각 계층에서 헤더와 데이터를 합친 부분. 1계층 PDU는 비트, 2계층 PDU는 프레임, 3계층은 패킷, 4계층은 세그먼트라고 부르고 애플리케이션에 해당하는 3개 계층은 데이터라고 부름

## 스위치 장비 동작

- 스위치가 없던 오래된 이더넷 네트워크에서는 패킷을 전송할 때 서로 경합해 그로 인한 네트워크 성능 저하가 컸음.
- 스위치의 핵심 역할은 누가 어느 위치에 있는지 파악하고 실제 통신이 시작되면 자신이 알고 있는 위치로 패킷을 정확히 전송하는 일
- 2계층 주소를 이해하고 단말의 주소인 MAC 주소와 단말이 위치하는 인터페이스 정보를 매핑한 MAC 주소 테이블을 갖고 있어서 가능함
- 전송하려는 패킷의 헤더 안에 있는 2계층 목적지 주소를 확인하고 MAC 주소 테이블에서 해당 주소가 어느 포트에 있는지 확인해 해당 패킷을 그 포트로만 전송함
- 만약 테이블에 없는 도착지 주소를 가진 패킷이 스위치로 들어오면 스위치는 전체 포트로 패킷을 전송함. 패킷의 도착지 주소가 테이블에 있으면 해당 주소가 매핑된 포트로만 패킷을 전송하고 다른 포트로는 전송하지 않음. 

### 플러딩

- 스위치를  부팅하면 네트워크 관련 정보가 아무것도 없음.(허브처럼 작동)
- 스위치가 허브와 같이 모든 포트로 패킷을 흘리는 동작 방식을 플러딩이라 함.
- 패킷이 들어오면 도착지 MAC주소를 확인하고 자신이 갖고 있는 MAC 주소 테이블에서 해당 MAC 주소가 있는지 확인. MAC 주소 테이블에 매칭되는 목적지 MAC 주소 정보가 없으면 모든 포트에 같은 내용의 패킷을 전송함.
- 이더넷-TCP/IP 네트워크에서는 ARP 브로드캐스트를 미리 주고받은 후 데이터가 전달되므로 실제로 데이터를 보내고 받을 때는 스위치가 패킷을 플러딩하지 않음

### 어드레스 러닝

- MAC 주소 테이블을 만들고 유지하는 과정을 어드레스 러닝이라고 함

- 패킷이 특정 포트에 들어오면 스위치에는 해당 패킷의 출발지 MAC 주소와 포트번호를 MAC 주소 테이블에 기록함

- 출발지의 MAC 주소 정보를 사용하므로 브로드캐스트나 멀티캐스트에 대한 MAC 주소를 학습할 수 없음

- 사전 정의된 MAC 주소 테이블

  대부분 스위치 간 통신을 위해 사용되는 주소. 이런 종류의 주소도 MAC 주소 테이블에서 정보를 확인할 수 있음. 스위치에서 자체 처리되는 주소는 특정 포트로 내보내는 것이 아니라 스위치에서 자체 처리하므로 인접 포트 정보가 없거나 CPU 혹은 관리 모듈을 지칭하는 용어로 표기됨.

### 포워딩/필터링

- 패킷이 스위치에 들어온 경우, 도착지 MAC 주소를 확인하고 자신이 가진 MAC 테이블과 비교해 맞는 정보가 있으면 매치되는 해당 포트로 패킷을 **포워드**함.
- 이 때 다른 포트로는 해당 패킷을 보내지 않으므로 이 동작을 **필터링**이라고 함
- 스위치에서는 포워딩과 필터링 작업이 여러 포트에서 동시에 수행될 수 있음.
- 스위치는 일반적인 유니캐스트에 대해서만 포워딩과 필터링 작업을 수행

### LAN에서의 ARP - 스위치 동작

- 패킷을 만들기 전에 통신해야 하는 단말의 MAC 주소를 알아내기 위해 ARP 브로드캐스트가 먼저 수행되어야 하므로 유니캐스트보다 ARP 브로드캐스트가 먼저 네트워크에 전달됨.
- 에이징 타임 - ARP와 MAC 테이블은 일정시간 지워지지 않는데, 해당 시간을 말함
- 일반적으로 MAC 테이블의 에이징 타임이 단말의 ARP 에이징 타임보다 길어 이더넷 네트워크를 플러딩없이 효율적으로 운영할 수 있음



## VLAN

물리적 배치와 상관없이 LAN을 논리적으로 분할, 구성하는 기술

- 한 대의 스위치를 여러 개의 VLAN으로 분할할 수 있음. 별도의 스위치처럼 동작
- VLAN을 나누면 하나의 장비를 서로 다른 네트워크를 갖도록 논리적으로 분할한 것이므로 유니캐스트뿐만 아니라 브로드캐스트도 VLAN간에 통신할 수 없음
- VLAN간의 통신을 위해서는 서로 다른 네트워크 간의 통신이므로 3계층 장비가 필요함
- 물리적으로 다른 층에 있는 단말이 하나의 VLAN을 사용해 동일한 네트워크로 묶을 수 있음

### VLAN의 종류와 특징

VLAN 할당 방식에는 포트 기반의 VLAN과 MAC 주소 기반의 VLAN이 있음.

- 포트 기반의 VLAN방식

  스위치를 논리적으로 분할해 사용하는 것이 목적. 어떤 단말에 접속하든지 스위치의 특정 포트에 VLAN을 할당하면 할당된 VLAN에 속하게 됨

- MAC 기반 VLAN

  사용자들의 자리 이동이 많아지면서 개발됨. 스위치의 고정 포트에 VLAN을 할당하는 것이 아니라 스위치에 연결되는 단말의 MAC 주소를 기반으로 VLAN을 할당하는 기술. 단말이 연결되면 단말의 MAC 주소를 인식한 스위치가 해당 포트를 지정된 VLAN으로 변경함

### VLAN모드(Trunk/Access) 동작 방식

- 여러 개의 VLAN이 존재하는 상황에서 스위치를 서로 연결해야 하는 경우에는 각 VLAN끼리 통신하려면 VLAN 개수만큼 포트를 연결해야 함. VLAN으로 분할된 스위치는 물리적인 별도의 스위치처럼 취급됨.
- VLAN 태그 기능 - 하나의 포트에 여러 개의 VLAN을 함께 전송할 수 있게 해줌. 이 포트를 태그 포트 or 트렁크 포트라고 함.
- 태그 - 스위치와 스위치의 프레임 전달 시에 하나의 포트에 다수의 VLAN이 지나갈 수 있도록 기능하는 링크. 태그 설정이 적용된 양쪽 스위치의 포트를 태그포트라고 함.
- 엑세스 포트 - 태그가 적용되지 않은 일반 포트(하나의 VLAN만이 설정되어있는 포트)
- ![vlan](C:\Users\user\Desktop\vlan.PNG)
- 태그 포트는 통신할 때 이더넷 프레임 중간에 VLAN ID필드를 끼워 넣어 정보를 이용함. 태그 포트로 패킷을 보낼 때는 VLAN ID를 붙이고 수신 측에서는 VLAN ID를 제거하면서 VLAN ID의 VLAN으로 패킷을 보낼 수 있음



## STP

- SPoF - 하나의 시스템이나 구성 요소에서 고장이 발생했을 때 전체 시스템의 작동이 멈추는 요소
- 네트워크도 하나의 장비 고장으로 전체 네트워크가 마비되는 것을 막기 위해 이중화, 다중화된 네트워크를 디자인하고 구성함
- 네트워크 루프 - 두 대 이상의 스위치로 디자인하면 패킷이 네트워크를 따라 계속 전송되므로 네트워크가 마비되는 현상

### 루프

- 다양한 루프 구조
  1. 두 장비 간의 이중화 연결(이중화 프로토콜 미사용)
  2. 장비 간의 연결이 고리 형태로 연결(단일 고리)
  3. 장비 간의 연결이 고리 형태로 연결(중복 고리)

#### 브로드캐스트 스톰

- 루프구조로 네트워크가 연결된 상태에서 단말에서 브로드캐스트를 발생시키면 스위치는 이 패킷을 패킷이 유입된 포트를 제외한 모든 포트로 플러딩함.
- 플러딩된 패킷은 다른 스위치로도 보내지고 이 패킷을 받은 스위치는 패킷이 유입된 포트를 제외한 모든 포트로 다시 플러딩함 -> 브로드캐스트 스톰
- 브로드캐스트 스톰은 네트워크의 전체 대역폭을 차지하고 네트워크에 연결된 모든 단말이 브로드캐스트를 처리하기 위해 시스템 리소스를 사용하면서 스위치와 네트워크에 연결된 단말 간 통신이 거의 불가능한 상태가 됨.

#### 스위치 MAC 러닝 중복 문제

- 루프 구조에서 스위치는 출발지 MAC 주소를 학습하는데 직접 전달되는 패킷과 스위치를 돌아 들어간 패킷 간의 포트가 달라 MAC 주소를 정상적으로 학습할 수 없음.

- MAC 어드레스 플래핑

  스위치 MAC 주소 테이블에서는 하나의 MAC 주소에 대한 하나의 포트만 학습할 수 있으므로 동일한 MAC 주소가 여러 포트에서 학습되면 MAC 테이블이 반복 갱신되어 정상적으로 동작하지 않음.

- 이런 현상이 발생하면 스위치에서 학습된 주소의 포트가 계속 변경되므로 스위치가 정상적으로 작동하지 못하고 패킷을 플러딩함.

### STP란

루프를 확인하고 적절히 포트를 사용하지 못하게 만들어 루프를 예방하는 매커니즘

- STP를 통해 루프를 예방하려면 전체 스위치가 어떻게 연결되는지 알아야 함.
- 전체적인 스위치 연결 상황을 파악하려면 스위치 간에 정보를 전달하는 방법이 필요
- 이를 위해 스위치는 BPDU라는 프로토콜을 통해 스위치 간에 정보를 전달하고 이렇게 수집된 정보를 이용해 전체 네트워크 트리를 만들어 루프 구간을 확인함.
- BPDU에는 스위치가 갖고 있는 ID와 같은 고유값이 들어가고 이런 정보들이 스위치 간에 서로 교환되면서 루프 파악이 가능해짐. 이렇게 확인된 루프 지점을 데이터 트래픽이 통과하지 못하도록 차단해 루프를 예방시킴

#### 스위치 포트의 상태 및 변경 과정

- STP가 동작중인 스위치에서는 루프를 막기 위해 스위치에서는 스위치 포트에 신규 스위치가 연결되면 바로 트래픽이 흐르지 않도록 차단함.
- 이후 해당 포트로 트래픽이 흘러도 되는지 확인하기 위해 BPDU를 기다려 학습하고 구조를 파악한 후 트래픽을 흘리거나 루프 구조인 경우, 차단 상태를 유지
- 차단 상태에서 트래픽이 흐를 때까지 스위치 포트의 상태는 4가지로 구분할 수 있음
  - Blocking
    - 패킷 데이터를 차단한 상태로 상대방이 보내는 BPDU를 기다림
    - 총 20초인 Max Age기간 동안 상대방 스위치에서 BPDU를 받지 못했거나 후순위 BPDU를 받았을 때 포트는 리스닝 상태로 변경됨
    - BPDU 기본 교환 주기는 2초이고 10번의 BPDU를 기다림
  - Listening
    - 전송 상태로 변경되는 것을 결정하고 준비하는 단계
    - 총 15초 대기하며 이 상태부터 나신의 BPDU 정보를 상대방에게 전송하기 시작
  - Learning
    - 이미 해당 포트를 포워딩하기로 결정하고 실제로 패킷 포워딩이 일어날 때 스위치가 곧바로 동작하도록 MAC 주소를 러닝하는 단계
    - 총 15초 대기
  - Forwarding
    - 패킷을 포워딩하는 단계. 정상적인 통신이 가능
- 새로 연결된 단말이 스위치일 가능성이 있어 BPDU를 일정 시간 기다려 스위치 여부를 파악 -> 일반 단말을 연결하더라도 통신하는 데 동일한 시간이 필요함

#### STP 동작방식

- 루트 스위치 - 네트워크 상에서 뿌리가 되는 가장 높은 위치를 선출하고 해당 스위치를 통해 모든 BPDU가 교환되도록 하는 스위치

- 모든 스위치는 처음에 자신을 루트 스위치로 인식해 동작

- BPDU를 통해 2초마다 자신이 루트 스위치임을 광고하는데 새로운 스위치가 들어오면 서로 교환된 BPDU에 들어있는 브릿지 ID값을 비교하여 더 적은 스위치를 루트 스위치로 선정하고 루트 스위치로 선정된 스위치가 BPDU를 다른 스위치 쪽으로 보냄

- STP의 동작방식

  1. 하나의 루트 스위치를 선정

     A. 전체 네트워크에 하나의 루트 스위치를 선정

     B. 자신을 전체 네트워크의 대표 스위치로 적은 BPDU를 옆 스위치로 전달

  2. 루트가 아닌 스위치 중 하나의 루트 포트를 선정

     A. 루트 브릿지로 가는, 경로가 가장 짧은 포트를 루프 포트라고 함

     B. 루프 브릿지에서 보낸 BPDU를 받는 포트

  3. 하나의 세그먼트에 하나의 지정 포트를 선정

     A. 스위치와 스위치가 연결되는 포트는 하나의 지정 포트를 선정함

     B. 스위치 간의 연결에서 이미 루트 포트로 선정된 경우, 반대쪽이 지정 포트로 선정되어 양쪽 모두 포워딩 상태가 됨

     C. 스위치 간의 연결에서 아무도 루프 포트가 아닐 경우, 한쪽은 지정 포트로 선정되고 다른 한쪽은 대체 포트가 되어 차단 상태가 됨.

     D. BPDU가 전달되는 포트

### 향상된 STP(RSTP, MST)

STP는 루프를 예방하기 위해 같은 네트워크에 속한 모든 스위치까지 BPDU가 전달되는 시간을 고려함. 

-> 블로킹 포트가 포워딩 상태로 변경될 때까지 30~50초가 소요됨

또한, 스위치에 여러 개의 VLAN이 있으면 각 VLAN별로 STP를 계산하면서 부하가 발생하기도 함.

#### RSTP

- 절체 시간이 2~3초로 짧아 일반적인 TCP 기반 애플리케이션이 세션을 유지할 수 있게 됨
- 기본적인 구성과 동작 방식은 STP와 같지만 BPDU메시지 형식이 다양해져 여러 가지 상태 메시지를 교환할 수 있음.
- STP는 일반 토폴로지 변경과 관련된 두 가지 메시지(TCN, TCA BPDU)만 있지만 RSTP는 8개 비트를 모두 활용해 다양한 정보를 주위 스위치와 주고받을 수 있음
- 루트 브릿지에 보고하고 전파되는 형식이 아니라 터미널 스위치가 토폴로지 변화를 다른 브릿지에게 직접 알려준다.
- 다양한 BPDU 메시지, 대체 포트 개념, 토폴로지 변경 전달 방식의 변화로 일반 STP보다 빠른 시간 내에 토폴로지 변경을 감지, 복구할 수 있음.

#### MST

- 일반적인 RST는 VLAN 개수와 상관없이 한 개만 동작하게 됨. 이 경우, VLAN이 많더라도 RST는 한개만 동작하면 되므로 스위치의 관리 부하가 적음.
- 그러나, RST는 루프가 생기는 토폴로지에서 한 개의 포트와 회선만 활성화되므로 자원을 효율적으로 활용할 수 없음. 또한, VLAN마다 최적의 경로가 다를 수 있는데 포트 하나만 사용할 수 있다보니 멀리 돌아 통신해야 할 경우도 생김
- 해당 문제를 해결하기 위해 PVST가 개발되었고 VLAN마다 다른 STP가 동작하므로 VLAN마다 별도의 경로와 트리를 만들 수 있게 됨
- 따라서 최적의 경로를 디자인하고 VLAN마다 별도의 플록 포트를 지정해 네트워크 로드를 셰어링하도록 구성할 수 있게 되었음
- 그러나 STP자체가 스위치에 많은 부담을 주는 프로토콜인데 PVST는 모든 VLAN마다 별도의 STP를 유지해야 하므로 더 많은 부담이 되어 MST가 개발되었음.
- **여러 개의 VLAN을 그룹으로 묶고 그 그룹마다 별도의 스패팅 트리가 동작함.**
- PVST보다 훨씬 적은 STP 프로세스가 돌게 되고 PVST의 장점인 로드 셰어링 기능도 함께 사용할 수 있음

